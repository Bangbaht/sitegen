#!/usr/bin/env node

import debug                  from 'debug';

debug.enable('sitegen:compiler:*');

import Webpack                from 'webpack';
import {parse, configure}     from '../CLIUtils';

let {site, options} = parse(process.argv, parser => {
  parser = parser.option('-o, --output <directory>', 'output directory');
  parser = parser.option('--only-pages', 'build only pages');
  parser = parser.option('--only-assets', 'build only assets');
  parser = parser.option('--dev', 'build assets in dev mode');
  return parser;
});

if (!options.onlyPages) {
  let renderAssets = Webpack(configure(site, {
    lib: options.lib,
    output: options.output,
    require: options.require,
    dev: options.dev,
    mode: 'serve',
    compilerName: 'assets',
  }));

  renderAssets.run(function(error) {
    if (error) {
      process.nextTick(function() {
        throw error;
      });
    }
  });
}

if (!options.onlyAssets) {
  let renderPages = Webpack(configure(site, {
    lib: options.lib,
    output: options.output,
    require: options.require,
    mode: 'build',
    compilerName: 'pages',
  }));

  renderPages.run(function(error) {
    if (error) {
      process.nextTick(function() {
        throw error;
      });
    }
  });
}
